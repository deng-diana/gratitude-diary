# å¾®ä¿¡ç™»å½•æ¥å…¥è¯„ä¼°ä¸é…ç½®æŒ‡å—

## ğŸ“‹ æ¥å…¥è¯„ä¼°

### âœ… ä¼˜åŠ¿
1. **ç”¨æˆ·è¦†ç›–ç‡é«˜**ï¼šå¾®ä¿¡åœ¨ä¸­å›½æœ‰è¶…è¿‡12äº¿ç”¨æˆ·ï¼Œå‡ ä¹æ‰€æœ‰ä¸­å›½ç”¨æˆ·éƒ½æœ‰å¾®ä¿¡è´¦å·
2. **ç”¨æˆ·ä½“éªŒå¥½**ï¼šä¸€é”®ç™»å½•ï¼Œæ— éœ€è®°ä½å¯†ç 
3. **å·²æœ‰åŸºç¡€**ï¼šæ‚¨å·²æœ‰å…¬å¸å®ä½“çš„å¾®ä¿¡å¼€å‘è€…è´¦å·ï¼ŒèŠ‚çœæ³¨å†Œæ—¶é—´

### âš ï¸ å¤æ‚åº¦è¯„ä¼°

**æ€»ä½“è¯„ä¼°ï¼šä¸­ç­‰å¤æ‚åº¦ï¼ˆ3-5å¤©å¼€å‘æ—¶é—´ï¼‰**

#### å¼€å‘å·¥ä½œé‡åˆ†è§£ï¼š
1. **å¾®ä¿¡å¼€æ”¾å¹³å°é…ç½®**ï¼ˆ1-2å°æ—¶ï¼‰
   - åˆ›å»ºç§»åŠ¨åº”ç”¨
   - è·å–AppIDå’ŒAppSecret
   - é…ç½®æˆæƒå›è°ƒåŸŸå

2. **iOS SDKé›†æˆ**ï¼ˆ4-6å°æ—¶ï¼‰
   - å®‰è£…å¾®ä¿¡SDKä¾èµ–
   - é…ç½®Info.plist
   - å®ç°ç™»å½•æµç¨‹

3. **Android SDKé›†æˆ**ï¼ˆ4-6å°æ—¶ï¼‰
   - å®‰è£…å¾®ä¿¡SDKä¾èµ–
   - é…ç½®AndroidManifest.xml
   - å®ç°ç™»å½•æµç¨‹

4. **åç«¯é›†æˆ**ï¼ˆ4-6å°æ—¶ï¼‰
   - æ¥å…¥å¾®ä¿¡OAuth API
   - åœ¨Cognitoä¸­é…ç½®å¾®ä¿¡ä½œä¸ºIdentity Provider
   - å®ç°tokenäº¤æ¢é€»è¾‘

5. **å‰ç«¯UIè°ƒæ•´**ï¼ˆ2-3å°æ—¶ï¼‰
   - æ·»åŠ å¾®ä¿¡ç™»å½•æŒ‰é’®
   - å¤„ç†ç™»å½•å›è°ƒ

**æ€»è®¡ï¼šçº¦15-25å°æ—¶å¼€å‘æ—¶é—´ï¼ˆ2-3ä¸ªå·¥ä½œæ—¥ï¼‰**

### ğŸ“ å‰ç½®æ¡ä»¶æ£€æŸ¥æ¸…å•

- [x] å·²æœ‰å¾®ä¿¡å¼€å‘è€…è´¦å·ï¼ˆå…¬å¸å®ä½“ï¼‰
- [ ] åº”ç”¨å·²é€šè¿‡å¾®ä¿¡å¼€æ”¾å¹³å°å®¡æ ¸ï¼ˆéœ€è¦æäº¤å®¡æ ¸ææ–™ï¼‰
- [ ] æœ‰åˆæ³•çš„åº”ç”¨åŸŸåç”¨äºå›è°ƒURL
- [ ] æœ‰åº”ç”¨çš„App Bundle IDï¼ˆiOSï¼‰å’ŒPackage Nameï¼ˆAndroidï¼‰

### âš ï¸ æ³¨æ„äº‹é¡¹

1. **å®¡æ ¸è¦æ±‚**ï¼š
   - å¾®ä¿¡ç™»å½•åŠŸèƒ½éœ€è¦æäº¤å®¡æ ¸ï¼Œå®¡æ ¸æ—¶é—´é€šå¸¸ä¸º3-7ä¸ªå·¥ä½œæ—¥
   - éœ€è¦æä¾›åº”ç”¨çš„è¯¦ç»†è¯´æ˜å’Œä½¿ç”¨åœºæ™¯

2. **å›è°ƒåŸŸå**ï¼š
   - éœ€è¦é…ç½®åˆæ³•çš„HTTPSå›è°ƒåŸŸå
   - å¯ä»¥æ˜¯æ‚¨çš„APIåŸŸåæˆ–Cognitoè‡ªå®šä¹‰åŸŸå

3. **SDKä¾èµ–**ï¼š
   - React Nativeéœ€è¦ä½¿ç”¨ç¬¬ä¸‰æ–¹åº“ï¼ˆå¦‚`react-native-wechat`ï¼‰
   - éœ€è¦åŸç”Ÿä»£ç é…ç½®ï¼ˆiOSå’ŒAndroidï¼‰

4. **Cognitoé…ç½®**ï¼š
   - éœ€è¦åœ¨AWS Cognitoä¸­é…ç½®å¾®ä¿¡ä½œä¸ºOIDC Identity Provider
   - éœ€è¦é…ç½®å¾®ä¿¡çš„æˆæƒç«¯ç‚¹ã€tokenç«¯ç‚¹ç­‰

---

## ğŸš€ æ¥å…¥æ­¥éª¤ï¼ˆè¯¦ç»†æŒ‡å—ï¼‰

### ç¬¬ä¸€æ­¥ï¼šå¾®ä¿¡å¼€æ”¾å¹³å°é…ç½®

#### 1.1 åˆ›å»ºç§»åŠ¨åº”ç”¨

1. ç™»å½• [å¾®ä¿¡å¼€æ”¾å¹³å°](https://open.weixin.qq.com/)
2. è¿›å…¥"ç®¡ç†ä¸­å¿ƒ" â†’ "ç½‘ç«™åº”ç”¨"æˆ–"ç§»åŠ¨åº”ç”¨"
3. ç‚¹å‡»"åˆ›å»ºç§»åŠ¨åº”ç”¨"
4. å¡«å†™åº”ç”¨ä¿¡æ¯ï¼š
   - **åº”ç”¨åç§°**ï¼šæ‚¨çš„åº”ç”¨åç§°
   - **åº”ç”¨ç®€ä»‹**ï¼šç®€è¦æè¿°åº”ç”¨åŠŸèƒ½
   - **åº”ç”¨å›¾æ ‡**ï¼šä¸Šä¼ åº”ç”¨å›¾æ ‡ï¼ˆ512x512åƒç´ ï¼‰
   - **åº”ç”¨åˆ†ç±»**ï¼šé€‰æ‹©åˆé€‚åˆ†ç±»

#### 1.2 è·å–AppIDå’ŒAppSecret

åˆ›å»ºåº”ç”¨åï¼Œåœ¨åº”ç”¨è¯¦æƒ…é¡µé¢å¯ä»¥æ‰¾åˆ°ï¼š
- **AppID**ï¼šåº”ç”¨çš„å”¯ä¸€æ ‡è¯†
- **AppSecret**ï¼šç”¨äºéªŒè¯åº”ç”¨èº«ä»½çš„å¯†é’¥ï¼ˆè¯·å¦¥å–„ä¿ç®¡ï¼‰

#### 1.3 é…ç½®iOSå¹³å°

1. åœ¨åº”ç”¨è¯¦æƒ…é¡µé¢ï¼Œç‚¹å‡»"iOSå¹³å°"
2. å¡«å†™iOSé…ç½®ä¿¡æ¯ï¼š
   - **Bundle ID**ï¼šæ‚¨çš„iOSåº”ç”¨çš„Bundle IDï¼ˆå¦‚ï¼š`com.yourcompany.gratitudediary`ï¼‰
   - **Universal Links**ï¼šé…ç½®æ‚¨çš„åº”ç”¨çš„Universal Linksï¼ˆå¯é€‰ï¼‰

#### 1.4 é…ç½®Androidå¹³å°

1. åœ¨åº”ç”¨è¯¦æƒ…é¡µé¢ï¼Œç‚¹å‡»"Androidå¹³å°"
2. å¡«å†™Androidé…ç½®ä¿¡æ¯ï¼š
   - **åº”ç”¨åŒ…å**ï¼šæ‚¨çš„Androidåº”ç”¨çš„åŒ…åï¼ˆå¦‚ï¼š`com.yourcompany.gratitudediary`ï¼‰
   - **åº”ç”¨ç­¾å**ï¼šä¸Šä¼ åº”ç”¨çš„ç­¾åæ–‡ä»¶ï¼ˆç”¨äºéªŒè¯ï¼‰

#### 1.5 æäº¤å®¡æ ¸

å¡«å†™å®Œæ‰€æœ‰ä¿¡æ¯åï¼Œæäº¤å®¡æ ¸ã€‚å®¡æ ¸é€šè¿‡åï¼ŒAppIDå’ŒAppSecretæ‰ä¼šç”Ÿæ•ˆã€‚

---

### ç¬¬äºŒæ­¥ï¼šå®‰è£…ä¾èµ–

#### 2.1 React Nativeå¾®ä¿¡SDK

```bash
cd mobile
npm install react-native-wechat-lib
# æˆ–è€…
npm install react-native-wechat
```

#### 2.2 iOSé…ç½®ï¼ˆä½¿ç”¨CocoaPodsï¼‰

```bash
cd ios
pod install
```

#### 2.3 Androidé…ç½®

åœ¨`android/build.gradle`ä¸­æ·»åŠ ï¼š

```gradle
allprojects {
    repositories {
        // ... å…¶ä»–ä»“åº“
        flatDir {
            dirs 'libs'
        }
    }
}
```

---

### ç¬¬ä¸‰æ­¥ï¼šä»£ç å®ç°

#### 3.1 iOSé…ç½®

åœ¨`ios/YourApp/Info.plist`ä¸­æ·»åŠ ï¼š

```xml
<key>CFBundleURLTypes</key>
<array>
    <dict>
        <key>CFBundleTypeRole</key>
        <string>Editor</string>
        <key>CFBundleURLSchemes</key>
        <array>
            <string>wxYourAppID</string>
        </array>
    </dict>
</array>
```

åœ¨`ios/YourApp/AppDelegate.m`ä¸­æ·»åŠ ï¼š

```objc
#import <WXApi.h>

- (BOOL)application:(UIApplication *)application handleOpenURL:(NSURL *)url {
    return [WXApi handleOpenURL:url delegate:self];
}

- (BOOL)application:(UIApplication *)application openURL:(NSURL *)url sourceApplication:(NSString *)sourceApplication annotation:(id)annotation {
    return [WXApi handleOpenURL:url delegate:self];
}
```

#### 3.2 Androidé…ç½®

åœ¨`android/app/src/main/AndroidManifest.xml`ä¸­æ·»åŠ ï¼š

```xml
<activity
    android:name=".wxapi.WXEntryActivity"
    android:exported="true"
    android:taskAffinity="${applicationId}"
    android:launchMode="singleTask">
    <intent-filter>
        <action android:name="android.intent.action.VIEW"/>
        <category android:name="android.intent.category.DEFAULT"/>
        <data android:scheme="wxYourAppID"/>
    </intent-filter>
</activity>
```

#### 3.3 å‰ç«¯å®ç°

åˆ›å»º`mobile/src/services/wechatAuthService.ts`ï¼š

```typescript
import { NativeModules } from 'react-native';
import WeChat from 'react-native-wechat-lib';

const WECHAT_APP_ID = 'your_wechat_app_id'; // ä»å¾®ä¿¡å¼€æ”¾å¹³å°è·å–

export async function signInWithWeChat(): Promise<string> {
  try {
    // æ³¨å†Œå¾®ä¿¡SDK
    await WeChat.registerApp(WECHAT_APP_ID);
    
    // å‘é€ç™»å½•è¯·æ±‚
    const result = await WeChat.sendAuthRequest('snsapi_userinfo');
    
    if (result.code) {
      // ä½¿ç”¨codeæ¢å–access_tokenå’Œopenid
      return result.code;
    } else {
      throw new Error('å¾®ä¿¡ç™»å½•å¤±è´¥');
    }
  } catch (error) {
    console.error('å¾®ä¿¡ç™»å½•é”™è¯¯:', error);
    throw error;
  }
}
```

#### 3.4 åç«¯å®ç°

åœ¨`backend/app/routers/auth.py`ä¸­æ·»åŠ ï¼š

```python
from fastapi import APIRouter, HTTPException
import requests
import os

router = APIRouter()

WECHAT_APP_ID = os.getenv('WECHAT_APP_ID')
WECHAT_APP_SECRET = os.getenv('WECHAT_APP_SECRET')

class WeChatLoginRequest(BaseModel):
    code: str  # å¾®ä¿¡è¿”å›çš„code

@router.post("/wechat", response_model=AuthResponse)
async def wechat_login(request: WeChatLoginRequest):
    """
    å¾®ä¿¡ç™»å½•ç«¯ç‚¹
    
    æµç¨‹ï¼š
    1. ä½¿ç”¨codeæ¢å–access_tokenå’Œopenid
    2. è·å–ç”¨æˆ·ä¿¡æ¯
    3. åœ¨Cognitoä¸­åˆ›å»ºæˆ–è·å–ç”¨æˆ·
    4. è¿”å›Cognito tokens
    """
    try:
        # 1. ä½¿ç”¨codeæ¢å–access_token
        token_url = f"https://api.weixin.qq.com/sns/oauth2/access_token"
        token_params = {
            'appid': WECHAT_APP_ID,
            'secret': WECHAT_APP_SECRET,
            'code': request.code,
            'grant_type': 'authorization_code'
        }
        
        token_response = requests.get(token_url, params=token_params)
        token_data = token_response.json()
        
        if 'access_token' not in token_data:
            raise HTTPException(status_code=401, detail="è·å–å¾®ä¿¡tokenå¤±è´¥")
        
        access_token = token_data['access_token']
        openid = token_data['openid']
        
        # 2. è·å–ç”¨æˆ·ä¿¡æ¯
        user_info_url = f"https://api.weixin.qq.com/sns/userinfo"
        user_params = {
            'access_token': access_token,
            'openid': openid
        }
        
        user_response = requests.get(user_info_url, params=user_params)
        user_data = user_response.json()
        
        if 'openid' not in user_data:
            raise HTTPException(status_code=401, detail="è·å–å¾®ä¿¡ç”¨æˆ·ä¿¡æ¯å¤±è´¥")
        
        # 3. åœ¨Cognitoä¸­åˆ›å»ºæˆ–è·å–ç”¨æˆ·ï¼ˆç±»ä¼¼äºAppleç™»å½•çš„é€»è¾‘ï¼‰
        # ... å®ç°Cognitoç”¨æˆ·åˆ›å»º/è®¤è¯é€»è¾‘ ...
        
        return AuthResponse(...)
        
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"å¾®ä¿¡ç™»å½•å¤±è´¥: {str(e)}")
```

---

### ç¬¬å››æ­¥ï¼šAWS Cognitoé…ç½®

#### 4.1 æ·»åŠ å¾®ä¿¡ä½œä¸ºOIDC Identity Provider

1. ç™»å½•AWSæ§åˆ¶å°ï¼Œè¿›å…¥Cognito
2. é€‰æ‹©æ‚¨çš„User Pool
3. è¿›å…¥"Sign-in experience" â†’ "Federated identity provider sign-in"
4. ç‚¹å‡»"Add identity provider"
5. é€‰æ‹©"OpenID Connect"
6. å¡«å†™é…ç½®ï¼š
   - **Provider name**ï¼šWeChat
   - **Client ID**ï¼šæ‚¨çš„å¾®ä¿¡AppID
   - **Authorized scopes**ï¼š`snsapi_userinfo`
   - **Issuer URL**ï¼š`https://open.weixin.qq.com`

#### 4.2 é…ç½®å±æ€§æ˜ å°„

- `sub` â†’ `cognito:username`
- `nickname` â†’ `name`
- `headimgurl` â†’ `picture`

---

### ç¬¬äº”æ­¥ï¼šå‰ç«¯UIé›†æˆ

åœ¨`mobile/src/screens/LoginScreen.tsx`ä¸­æ·»åŠ å¾®ä¿¡ç™»å½•æŒ‰é’®ï¼š

```typescript
import { signInWithWeChat } from '../services/wechatAuthService';

// åœ¨buttonSectionä¸­æ·»åŠ 
<TouchableOpacity
  style={[styles.button, styles.wechatButton]}
  onPress={handleWeChatSignIn}
  disabled={loading}
>
  <Ionicons name="logo-wechat" size={24} color="#07C160" />
  <Text style={styles.wechatButtonText}>
    {t("login.wechatSignIn")}
  </Text>
</TouchableOpacity>
```

---

## ğŸ“š å‚è€ƒèµ„æ–™

1. [å¾®ä¿¡å¼€æ”¾å¹³å°æ–‡æ¡£](https://developers.weixin.qq.com/doc/oplatform/Mobile_App/Access_Guide/iOS.html)
2. [å¾®ä¿¡ç™»å½•æ¥å…¥æŒ‡å—](https://developers.weixin.qq.com/doc/oplatform/en/Website_App/WeChat_Login/Wechat_Login.html)
3. [AWS Cognito OIDCé…ç½®](https://docs.aws.amazon.com/cognito/latest/developerguide/cognito-user-pools-oidc-idp.html)

---

## ğŸ¯ æ€»ç»“

### æ¥å…¥éš¾åº¦ï¼šâ­â­â­ï¼ˆä¸­ç­‰ï¼‰

**é€‚åˆæ¥å…¥çš„æƒ…å†µ**ï¼š
- âœ… ä¸»è¦é¢å‘ä¸­å›½ç”¨æˆ·
- âœ… å·²æœ‰å¾®ä¿¡å¼€å‘è€…è´¦å·
- âœ… æœ‰2-3å¤©çš„å¼€å‘æ—¶é—´
- âœ… åº”ç”¨å·²é€šè¿‡æˆ–å¯ä»¥å¿«é€Ÿé€šè¿‡å¾®ä¿¡å®¡æ ¸

**å»ºè®®**ï¼š
1. å…ˆå®Œæˆç”¨æˆ·åå¯†ç ç™»å½•å’Œæ³¨å†ŒåŠŸèƒ½ï¼ˆå½“å‰å·²å®ç°ï¼‰
2. æ ¹æ®ç”¨æˆ·åé¦ˆå†³å®šæ˜¯å¦éœ€è¦æ¥å…¥å¾®ä¿¡ç™»å½•
3. å¦‚æœéœ€è¦ï¼ŒæŒ‰ç…§æœ¬æŒ‡å—é€æ­¥æ¥å…¥

### ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. åœ¨å¾®ä¿¡å¼€æ”¾å¹³å°åˆ›å»ºåº”ç”¨å¹¶æäº¤å®¡æ ¸
2. ç­‰å¾…å®¡æ ¸é€šè¿‡ï¼ˆ3-7ä¸ªå·¥ä½œæ—¥ï¼‰
3. æŒ‰ç…§æœ¬æŒ‡å—é€æ­¥å®ç°å¾®ä¿¡ç™»å½•åŠŸèƒ½
4. æµ‹è¯•å¹¶ä¸Šçº¿

---

## ğŸ’¡ ä¼˜åŒ–å»ºè®®

1. **æ¸è¿›å¼æ¥å…¥**ï¼šå…ˆå®ŒæˆåŸºæœ¬åŠŸèƒ½ï¼Œå†é€æ­¥æ¥å…¥ç¬¬ä¸‰æ–¹ç™»å½•
2. **ç”¨æˆ·æ•°æ®å¤‡ä»½**ï¼šå»ºè®®æ‰€æœ‰ç”¨æˆ·éƒ½ç»‘å®šé‚®ç®±ï¼Œä»¥é˜²ç¬¬ä¸‰æ–¹ç™»å½•å¤±æ•ˆ
3. **å¤šç™»å½•æ–¹å¼**ï¼šåŒæ—¶æ”¯æŒé‚®ç®±ç™»å½•å’Œå¾®ä¿¡ç™»å½•ï¼Œç»™ç”¨æˆ·æ›´å¤šé€‰æ‹©


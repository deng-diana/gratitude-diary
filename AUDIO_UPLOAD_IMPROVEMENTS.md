# éŸ³é¢‘ä¸Šä¼ æ”¹è¿›æ–¹æ¡ˆ

## é—®é¢˜åˆ†æ

### ç—‡çŠ¶
- âœ… 3åˆ†é’Ÿå½•éŸ³ä¸Šä¼ æˆåŠŸ
- âŒ 8åˆ†é’Ÿå½•éŸ³ä¸Šä¼ å¤±è´¥
- âŒ S3å’ŒCloudWatchéƒ½æ²¡æœ‰è®°å½•ï¼ˆè¯´æ˜å¤±è´¥å‘ç”Ÿåœ¨ä¸Šä¼ é˜¶æ®µï¼‰
- âŒ å‰ç«¯æ²¡æœ‰è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯

### æ ¹æœ¬åŸå› åˆ†æ

æ ¹æ®å½•éŸ³é…ç½®ï¼š
- **Bitrate**: 128kbps
- **8åˆ†é’Ÿç†è®ºå¤§å°**: 128kbps Ã— 480ç§’ Ã· 8 = **7.68MB**
- **å®é™…å¤§å°å¯èƒ½**: 8-12MBï¼ˆåŒ…å«m4aå®¹å™¨å…ƒæ•°æ®ï¼‰

**æœ€å¯èƒ½çš„åŸå› **ï¼š
1. **å•æ¬¡PUTè¯·æ±‚åœ¨ç§»åŠ¨ç½‘ç»œä¸‹ä¸ç¨³å®š**ï¼ˆé•¿è¿æ¥ + å¼±ç½‘ = å®¹æ˜“ä¸­æ–­ï¼‰
2. **æ²¡æœ‰è¶…æ—¶è®¾ç½®**ï¼ˆå¯èƒ½æ— é™ç­‰å¾…ï¼‰
3. **æ²¡æœ‰é‡è¯•æœºåˆ¶**ï¼ˆä¸€æ¬¡å¤±è´¥å°±æ”¾å¼ƒï¼‰
4. **é”™è¯¯ä¿¡æ¯ä¸æ˜ç¡®**ï¼ˆç”¨æˆ·ä¸çŸ¥é“å‘ç”Ÿäº†ä»€ä¹ˆï¼‰

## å·²å®ç°çš„æ”¹è¿›

### 1. âœ… æ–‡ä»¶å¤§å°æ£€æŸ¥å’Œè¯¦ç»†æ—¥å¿—

**æ–°å¢åŠŸèƒ½**ï¼š
- ä¸Šä¼ å‰æ£€æŸ¥æ–‡ä»¶å¤§å°
- è®°å½•å®é™…å¤§å° vs ç†è®ºå¤§å°
- è¶…è¿‡10MBæ—¶å‘å‡ºè­¦å‘Š

**ä»£ç ä½ç½®**ï¼š`checkAudioFileSize()` å‡½æ•°

**è¾“å‡ºç¤ºä¾‹**ï¼š
```
ğŸ“Š éŸ³é¢‘æ–‡ä»¶ä¿¡æ¯:
  - URI: file:///path/to/recording.m4a
  - æ—¶é•¿: 480ç§’ (8.00åˆ†é’Ÿ)
  - å®é™…å¤§å°: 9.23MB (9451KB, 9686784å­—èŠ‚)
  - ç†è®ºå¤§å° (128kbps): 7.68MB
  - å¤§å°æ¯”ç‡: 120.2%
```

### 2. âœ… è¶…æ—¶è®¾ç½®

**é…ç½®**ï¼š
- è¶…æ—¶æ—¶é—´ï¼š5åˆ†é’Ÿï¼ˆè¶³å¤Ÿé•¿ï¼Œä½†é˜²æ­¢æ— é™ç­‰å¾…ï¼‰
- ä½¿ç”¨ `AbortController` å®ç°è¶…æ—¶

**ä»£ç ä½ç½®**ï¼š`fetchWithTimeoutAndRetry()` å‡½æ•°

**æ•ˆæœ**ï¼š
- å¦‚æœä¸Šä¼ è¶…è¿‡5åˆ†é’Ÿï¼Œè‡ªåŠ¨å–æ¶ˆå¹¶æŠ¥é”™
- é¿å…ç”¨æˆ·æ— é™ç­‰å¾…

### 3. âœ… é‡è¯•æœºåˆ¶ï¼ˆæŒ‡æ•°é€€é¿ï¼‰

**é…ç½®**ï¼š
- æœ€å¤§é‡è¯•æ¬¡æ•°ï¼š3æ¬¡
- é‡è¯•å»¶è¿Ÿï¼š2ç§’ã€4ç§’ã€8ç§’ï¼ˆæŒ‡æ•°é€€é¿ï¼‰
- è‡ªåŠ¨é‡è¯•æ¡ä»¶ï¼š
  - è¶…æ—¶é”™è¯¯
  - ç½‘ç»œé”™è¯¯
  - 5xxæœåŠ¡å™¨é”™è¯¯

**ä»£ç ä½ç½®**ï¼š`fetchWithTimeoutAndRetry()` å‡½æ•°

**æ•ˆæœ**ï¼š
- ç½‘ç»œä¸´æ—¶ä¸­æ–­æ—¶è‡ªåŠ¨é‡è¯•
- æé«˜ä¸Šä¼ æˆåŠŸç‡

### 4. âœ… æ”¹è¿›çš„é”™è¯¯å¤„ç†

**åŒºåˆ†é”™è¯¯ç±»å‹**ï¼š
- **ä¸Šä¼ å¤±è´¥**ï¼šç½‘ç»œé”™è¯¯ã€è¶…æ—¶ã€è¿æ¥ä¸­æ–­
- **å¤„ç†å¤±è´¥**ï¼šæœåŠ¡å™¨é”™è¯¯ã€è®¤è¯å¤±è´¥

**ç”¨æˆ·å‹å¥½çš„é”™è¯¯ä¿¡æ¯**ï¼š
- è¶…æ—¶ï¼š`"ä¸Šä¼ è¶…æ—¶ï¼šéŸ³é¢‘æ–‡ä»¶å¯èƒ½è¿‡å¤§æˆ–ç½‘ç»œä¸ç¨³å®šã€‚æ–‡ä»¶å¤§å°: 9.23MBï¼Œå»ºè®®æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•ã€‚"`
- ç½‘ç»œé”™è¯¯ï¼š`"ç½‘ç»œé”™è¯¯ï¼šæ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ã€‚è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•ã€‚æ–‡ä»¶å·²ä¿å­˜åœ¨æœ¬åœ°ï¼Œå¯ä»¥ç¨åé‡è¯•ã€‚"`

**ä»£ç ä½ç½®**ï¼š`createVoiceDiaryTask()` å’Œ `createVoiceDiaryStream()` å‡½æ•°

## æ”¹è¿›æ•ˆæœ

### ä¹‹å‰
```
âŒ 8åˆ†é’Ÿå½•éŸ³ â†’ é™é»˜å¤±è´¥ â†’ ç”¨æˆ·ä¸çŸ¥é“å‘ç”Ÿäº†ä»€ä¹ˆ
```

### ç°åœ¨
```
âœ… 8åˆ†é’Ÿå½•éŸ³ â†’ æ£€æŸ¥æ–‡ä»¶å¤§å° â†’ è®°å½•è¯¦ç»†ä¿¡æ¯
âœ… ä¸Šä¼ å¤±è´¥ â†’ è‡ªåŠ¨é‡è¯•3æ¬¡ï¼ˆæŒ‡æ•°é€€é¿ï¼‰
âœ… ä»ç„¶å¤±è´¥ â†’ æ˜ç¡®çš„é”™è¯¯ä¿¡æ¯ + æ–‡ä»¶ä¿å­˜åœ¨æœ¬åœ°
```

## ä¸‹ä¸€æ­¥å»ºè®®ï¼ˆå¦‚æœé—®é¢˜ä»ç„¶å­˜åœ¨ï¼‰

### æ–¹æ¡ˆAï¼šMultipart Uploadï¼ˆæ¨èï¼‰

å¦‚æœæ–‡ä»¶ä»ç„¶å¤ªå¤§ï¼ˆ>20MBï¼‰ï¼Œå»ºè®®å®ç° **Multipart Upload**ï¼š

**å‰ç«¯å®ç°**ï¼š
1. å°†éŸ³é¢‘æ–‡ä»¶åˆ†ç‰‡ï¼ˆæ¯ç‰‡5MBï¼‰
2. ä½¿ç”¨ S3 Multipart Upload API
3. æ¯ç‰‡ç‹¬ç«‹ä¸Šä¼ ï¼Œå¤±è´¥åªé‡è¯•è¯¥ç‰‡
4. æ‰€æœ‰ç‰‡ä¸Šä¼ å®Œæˆåï¼Œè°ƒç”¨ `completeMultipartUpload`

**ä¼˜ç‚¹**ï¼š
- æ”¯æŒæ–­ç‚¹ç»­ä¼ 
- å•ç‰‡å¤±è´¥ä¸å½±å“å…¶ä»–ç‰‡
- é€‚åˆå¤§æ–‡ä»¶ä¸Šä¼ 

**éœ€è¦åç«¯æ”¯æŒ**ï¼š
- æä¾› `initiateMultipartUpload` ç«¯ç‚¹
- æä¾› `uploadPart` ç«¯ç‚¹ï¼ˆè¿”å›presigned URLï¼‰
- æä¾› `completeMultipartUpload` ç«¯ç‚¹

### æ–¹æ¡ˆBï¼šé™ä½éŸ³é¢‘è´¨é‡ï¼ˆä¸´æ—¶æ–¹æ¡ˆï¼‰

å¦‚æœæ–‡ä»¶å¤ªå¤§ï¼Œå¯ä»¥ä¸´æ—¶é™ä½å½•éŸ³è´¨é‡ï¼š

**ä¿®æ”¹å½•éŸ³é…ç½®**ï¼š
```typescript
// ä» 128kbps é™åˆ° 64kbps
bitRate: 64000,  // 8åˆ†é’Ÿ â‰ˆ 3.84MB
```

**ä¼˜ç‚¹**ï¼š
- å®ç°ç®€å•
- æ–‡ä»¶å¤§å°å‡åŠ

**ç¼ºç‚¹**ï¼š
- éŸ³è´¨é™ä½
- ä¸æ˜¯æ ¹æœ¬è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆCï¼šå‹ç¼©éŸ³é¢‘ï¼ˆå¦‚æœæ”¯æŒï¼‰

åœ¨ä¸Šä¼ å‰å‹ç¼©éŸ³é¢‘æ–‡ä»¶ï¼ˆå¦‚æœExpoæ”¯æŒï¼‰ï¼š
- ä½¿ç”¨ `expo-av` çš„å‹ç¼©åŠŸèƒ½
- æˆ–ä½¿ç”¨ç¬¬ä¸‰æ–¹åº“

## æµ‹è¯•å»ºè®®

1. **æµ‹è¯•ä¸åŒé•¿åº¦çš„å½•éŸ³**ï¼š
   - 3åˆ†é’Ÿï¼ˆåº”è¯¥æˆåŠŸï¼‰
   - 8åˆ†é’Ÿï¼ˆé‡ç‚¹æµ‹è¯•ï¼‰
   - 15åˆ†é’Ÿï¼ˆå‹åŠ›æµ‹è¯•ï¼‰

2. **æµ‹è¯•ä¸åŒç½‘ç»œæ¡ä»¶**ï¼š
   - WiFi
   - 4G/5G
   - å¼±ç½‘ï¼ˆå¯ä»¥æ¨¡æ‹Ÿï¼‰

3. **æ£€æŸ¥æ—¥å¿—**ï¼š
   - æŸ¥çœ‹æ–‡ä»¶å¤§å°æ—¥å¿—
   - æŸ¥çœ‹é‡è¯•æ—¥å¿—
   - æŸ¥çœ‹é”™è¯¯ä¿¡æ¯

## ç›‘æ§æŒ‡æ ‡

å»ºè®®æ·»åŠ ä»¥ä¸‹ç›‘æ§ï¼š
- ä¸Šä¼ æˆåŠŸç‡ï¼ˆæŒ‰æ–‡ä»¶å¤§å°åˆ†æ®µï¼‰
- å¹³å‡ä¸Šä¼ æ—¶é—´ï¼ˆæŒ‰æ–‡ä»¶å¤§å°åˆ†æ®µï¼‰
- é‡è¯•æ¬¡æ•°åˆ†å¸ƒ
- é”™è¯¯ç±»å‹åˆ†å¸ƒ

## ä»£ç å˜æ›´æ€»ç»“

### ä¿®æ”¹çš„æ–‡ä»¶
- `mobile/src/services/diaryService.ts`

### æ–°å¢å‡½æ•°
- `checkAudioFileSize()` - æ£€æŸ¥æ–‡ä»¶å¤§å°
- `fetchWithTimeoutAndRetry()` - å¸¦è¶…æ—¶å’Œé‡è¯•çš„fetch

### æ”¹è¿›çš„å‡½æ•°
- `createVoiceDiaryTask()` - æ·»åŠ æ–‡ä»¶æ£€æŸ¥ã€è¶…æ—¶ã€é‡è¯•
- `createVoiceDiaryStream()` - æ·»åŠ æ–‡ä»¶æ£€æŸ¥ã€è¶…æ—¶ã€é‡è¯•

### é…ç½®å¸¸é‡
- `AUDIO_UPLOAD_TIMEOUT_MS = 5 * 60 * 1000` (5åˆ†é’Ÿ)
- `AUDIO_UPLOAD_MAX_RETRIES = 3` (æœ€å¤š3æ¬¡)
- `AUDIO_UPLOAD_RETRY_DELAY_MS = 2000` (2ç§’åŸºç¡€å»¶è¿Ÿ)
- `AUDIO_SIZE_WARNING_THRESHOLD_MB = 10` (10MBè­¦å‘Šé˜ˆå€¼)

## é¢„æœŸæ•ˆæœ

1. **å¯è§‚æµ‹æ€§æå‡**ï¼š
   - æ¯æ¬¡ä¸Šä¼ éƒ½ä¼šè®°å½•æ–‡ä»¶å¤§å°
   - å¤±è´¥æ—¶ä¼šè®°å½•è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯

2. **å¯é æ€§æå‡**ï¼š
   - ç½‘ç»œä¸´æ—¶ä¸­æ–­æ—¶è‡ªåŠ¨é‡è¯•
   - è¶…æ—¶ä¿æŠ¤ï¼Œé¿å…æ— é™ç­‰å¾…

3. **ç”¨æˆ·ä½“éªŒæå‡**ï¼š
   - æ˜ç¡®çš„é”™è¯¯ä¿¡æ¯
   - æ–‡ä»¶ä¿å­˜åœ¨æœ¬åœ°ï¼Œå¯ä»¥é‡è¯•

## å¦‚æœé—®é¢˜ä»ç„¶å­˜åœ¨

å¦‚æœæ”¹è¿›å8åˆ†é’Ÿå½•éŸ³ä»ç„¶å¤±è´¥ï¼Œè¯·ï¼š

1. **æ£€æŸ¥æ—¥å¿—**ï¼š
   - æ–‡ä»¶å¤§å°æ˜¯å¤šå°‘ï¼Ÿ
   - æ˜¯å¦è§¦å‘äº†é‡è¯•ï¼Ÿ
   - é”™è¯¯ä¿¡æ¯æ˜¯ä»€ä¹ˆï¼Ÿ

2. **è€ƒè™‘Multipart Upload**ï¼š
   - å¦‚æœæ–‡ä»¶ > 20MBï¼Œå¼ºçƒˆå»ºè®®å®ç°Multipart Upload
   - éœ€è¦åç«¯æ”¯æŒ

3. **è”ç³»æˆ‘**ï¼š
   - æä¾›è¯¦ç»†çš„æ—¥å¿—ä¿¡æ¯
   - æˆ‘å¯ä»¥å¸®ä½ å®ç°Multipart Uploadæ–¹æ¡ˆ
